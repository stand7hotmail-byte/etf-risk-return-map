<!DOCTYPE html>
<html lang="ja" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF Risk-Return Map</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="/static/jwt-decode.min.js"></script>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script>
    
    <style>
        body {
            background-color: var(--bs-secondary-bg);
        }
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .content-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        #sidebar {
            width: 320px;
            flex-shrink: 0;
            overflow-y: auto;
            background-color: var(--bs-body-bg);
            border-right: 1px solid var(--bs-border-color);
        }
        #main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }
        #etf-checkboxes .form-check {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg bg-dark navbar-dark shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="/"><i class="bi bi-bullseye me-2"></i>ETF Risk-Return Map</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#navbarNav" aria-controls="navbarNav" 
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="/brokers">
                                <i class="bi bi-bank me-1"></i>証券会社比較
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/docs" target="_blank">
                                <i class="bi bi-file-text me-1"></i>API Docs
                            </a>
                        </li>
                    </ul>
                    <div class="d-flex ms-auto align-items-center">
                        <button class="btn btn-outline-light btn-sm me-2" id="theme-toggler" type="button">
                            <i class="bi bi-sun-fill"></i>
                        </button>
                        <div id="auth-controls">
                            <!-- Auth buttons will be dynamically inserted here by auth.js -->
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="content-wrapper">
            <!-- Sidebar -->
            <aside id="sidebar" class="p-3">
                <div class="mb-3">
                    <label for="etf-search-input" class="form-label fw-bold">Search ETFs</label>
                    <input type="text" id="etf-search-input" class="form-control" placeholder="Search by ticker or name...">
                </div>
                <div class="mb-3">
                    <label for="asset-class-filter" class="form-label fw-bold">Asset Class</label>
                    <select id="asset-class-filter" class="form-select">
                        <option value="all">All</option>
                        <option value="Stock">Stock</option>
                        <option value="Bond">Bond</option>
                        <option value="Commodity">Commodity</option>
                        <option value="Real Estate">Real Estate</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="region-filter" class="form-label fw-bold">Region</label>
                    <select id="region-filter" class="form-select">
                        <option value="all">All</option>
                        <option value="US">US</option>
                        <option value="Global">Global</option>
                        <option value="Global ex-US">Global ex-US</option>
                        <option value="Developed ex-US">Developed ex-US</option>
                        <option value="Emerging">Emerging</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="style-filter" class="form-label fw-bold">Style</label>
                    <select id="style-filter" class="form-select">
                        <option value="all">All</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="size-filter" class="form-label fw-bold">Size</label>
                    <select id="size-filter" class="form-select">
                        <option value="all">All</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="sector-filter" class="form-label fw-bold">Sector</label>
                    <select id="sector-filter" class="form-select">
                        <option value="all">All</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="theme-filter" class="form-label fw-bold">Theme</label>
                    <select id="theme-filter" class="form-select">
                        <option value="all">All</option>
                    </select>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <button id="select-all-btn" class="btn btn-outline-secondary btn-sm">Select All</button>
                    <button id="deselect-all-btn" class="btn btn-outline-secondary btn-sm">Deselect All</button>
                </div>
                <div id="etf-checkboxes" class="mt-3"></div>
            </aside>

            <!-- Main Content -->
            <main id="main-content">
                <!-- Auth & Portfolio Management -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Management</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="bi bi-person-circle me-2"></i>User Authentication</h6>
                                <div class="auth-section mb-3">
                                    <div class="input-group mb-2">
                                        <span class="input-group-text" style="width: 100px;">Username</span>
                                        <input type="text" id="auth-username" class="form-control" placeholder="Enter username" maxlength="50">
                                    </div>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text" style="width: 100px;">Password</span>
                                        <input type="password" id="auth-password" class="form-control" placeholder="Enter password" maxlength="128" aria-describedby="password-help-block">
                                    </div>
                                    <div id="password-help-block" class="form-text">
                                        Must be at least 8 characters long and contain an uppercase letter, a lowercase letter, and a number.
                                    </div>
                                    <div id="auth-buttons">
                                        <button id="register-btn" class="btn btn-secondary btn-sm">Register</button>
                                        <button id="login-btn" class="btn btn-primary btn-sm">Login</button>
                                        <button id="google-login-btn" class="btn btn-danger btn-sm">Login with Google</button>
                                        <button id="logout-btn" class="btn btn-outline-secondary btn-sm" style="display: none;">Logout</button>
                                    </div>
                                    <div id="auth-message" class="form-text text-danger mt-2"></div>
                                    <div id="logged-in-user" class="form-text text-success mt-2" style="display: none;">Logged in as: <strong></strong></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-briefcase-fill me-2"></i>Portfolio Management</h6>
                                <div class="portfolio-management-section">
                                    <div class="input-group mb-2">
                                        <input type="text" id="portfolio-name-input" class="form-control" placeholder="My Portfolio 1">
                                        <button id="save-portfolio-btn" class="btn btn-outline-primary">Save</button>
                                    </div>
                                    <div class="input-group">
                                        <select id="saved-portfolios-select" class="form-select"></select>
                                        <button id="load-portfolio-btn" class="btn btn-outline-secondary">Load</button>
                                        <button id="delete-portfolio-btn" class="btn btn-outline-danger">Delete</button>
                                        <button id="list-portfolios-btn" class="btn btn-outline-info"><i class="bi bi-arrow-clockwise"></i></button>
                                    </div>
                                    <div id="portfolio-message" class="form-text mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Analysis Area -->
                <div class="d-flex align-items-center mb-3">
                    <label for="data-period-select" class="form-label me-2 mb-0">Data Period:</label>
                    <select id="data-period-select" class="form-select me-3" style="width: 150px;">
                        <option value="1y">1 Year</option>
                        <option value="3y">3 Years</option>
                        <option value="5y" selected>5 Years</option>
                        <option value="10y">10 Years</option>
                    </select>
                    <button id="generate-map-btn" class="btn btn-primary"><i class="bi bi-arrows-fullscreen me-2"></i>Generate Map</button>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs" id="main-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="map-tab" data-bs-toggle="tab" data-bs-target="#map-tab-pane" type="button" role="tab">Risk-Return Map</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom-tab-pane" type="button" role="tab">Custom Portfolio</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced-tab-pane" type="button" role="tab">Advanced Tools</button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="main-tabs-content">
                    <!-- Risk-Return Map Pane -->
                    <div class="tab-pane fade show active" id="map-tab-pane" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-body">
                                <div id="graph" style="height: 60vh;"></div>
                                <hr>
                                <div id="portfolio-composition">
                                    <h5 class="card-title">Max Sharpe Ratio Portfolio Composition</h5>
                                    <div id="composition-details">Select ETFs and click 'Generate Map' to see composition.</div>
                                </div>
                                <div id="broker-recommendation" class="card mt-4 border-primary" style="display: none;">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0">
                                            <i class="bi bi-rocket-takeoff me-2"></i>
                                            このポートフォリオを実際に運用する
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="lead">
                                            分析したポートフォリオで実際に投資を始めてみませんか？
                                        </p>
                                        <p class="text-muted small">
                                            以下の証券会社では、選択したETFを低コストで取引できます。
                                        </p>

                                        <div id="recommended-brokers-list" class="row">
                                            <!-- JavaScriptで動的に生成 -->
                                        </div>

                                        <hr>
                                        <p class="text-muted small mb-0">
                                            <i class="bi bi-info-circle me-1"></i>
                                            これらは当サイトが提携する証券会社です。口座開設により当サイトに報酬が発生する場合がありますが、
                                            あなたに追加費用は一切かかりません。
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Portfolio Pane -->
                    <div class="tab-pane fade" id="custom-tab-pane" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title">Create Your Custom Portfolio</h5>
                                <div id="portfolio-sliders"></div>
                                <button id="calculate-custom-portfolio-btn" class="btn btn-success mt-3">Calculate Custom Portfolio</button>
                                <div id="custom-portfolio-result" class="mt-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Tools Pane -->
                    <div class="tab-pane fade" id="advanced-tab-pane" role="tabpanel">
                        <div class="accordion mt-3" id="advanced-tools-accordion">
                            <!-- Target Optimization -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-optimize">
                                        Target Optimization
                                    </button>
                                </h2>
                                <div id="collapse-optimize" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <p>Enter a target return or risk to find the optimal portfolio.</p>
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">Target Return (%)</span>
                                            <input type="number" id="target-return-input" class="form-control" step="0.01" min="0" max="100" placeholder="e.g., 10">
                                            <button id="optimize-by-return-btn" class="btn btn-outline-secondary">Optimize</button>
                                        </div>
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">Target Risk (%)</span>
                                            <input type="number" id="target-risk-input" class="form-control" step="0.01" min="0" max="100" placeholder="e.g., 15">
                                            <button id="optimize-by-risk-btn" class="btn btn-outline-secondary">Optimize</button>
                                        </div>
                                        <div id="target-optimization-result" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Correlation Matrix -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-correlation">
                                        Correlation Matrix
                                    </button>
                                </h2>
                                <div id="collapse-correlation" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <p>Visualize how selected ETFs move in relation to each other.</p>
                                        <button id="show-correlation-matrix-btn" class="btn btn-info">Show Correlation</button>
                                        <div id="correlation-matrix-graph" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Historical Performance -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-historical">
                                        Historical Performance
                                    </button>
                                </h2>
                                <div id="collapse-historical" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <p>View the cumulative historical performance of selected ETFs.</p>
                                        <button id="show-historical-performance-btn" class="btn btn-info">Show Performance</button>
                                        <div id="historical-performance-graph" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Monte Carlo -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-monte-carlo">
                                        Monte Carlo Simulation
                                    </button>
                                </h2>
                                <div id="collapse-monte-carlo" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <p>Simulate future portfolio returns based on historical data.</p>
                                        <div class="row">
                                            <div class="col-md-6"><input type="number" id="num-simulations-input" value="1000" min="100" step="100" class="form-control" placeholder="Number of Simulations"></div>
                                            <div class="col-md-6"><input type="number" id="simulation-days-input" value="252" min="1" step="1" class="form-control" placeholder="Simulation Days"></div>
                                        </div>
                                        <button id="run-monte-carlo-btn" class="btn btn-info mt-2">Run Simulation</button>
                                        <div id="monte-carlo-graph" class="mt-2"></div>
                                        <div id="monte-carlo-results" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- DCA Simulation -->
                             <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-dca">
                                        Dollar-Cost Averaging Simulation
                                    </button>
                                </h2>
                                <div id="collapse-dca" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <p>Simulate the growth of your portfolio with regular investments.</p>
                                        <div class="input-group">
                                            <span class="input-group-text">Amount</span>
                                            <input type="number" id="dca-amount-input" value="100" step="10" class="form-control">
                                            <span class="input-group-text">Frequency</span>
                                            <select id="dca-frequency-select" class="form-select">
                                                <option value="monthly" selected>Monthly</option>
                                                <option value="quarterly">Quarterly</option>
                                            </select>
                                            <span class="input-group-text">Years</span>
                                            <input type="number" id="dca-years-input" value="10" step="1" class="form-control">
                                            <button id="run-dca-simulation-btn" class="btn btn-info">Run</button>
                                        </div>
                                        <div id="dca-simulation-graph" class="mt-2"></div>
                                        <div id="dca-simulation-results" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- CSV Upload -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-csv">
                                        Analyze from CSV
                                    </button>
                                </h2>
                                <div id="collapse-csv" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        <p>Upload a CSV file with historical data (Date, TICKER1, TICKER2, ...)</p>
                                        <div class="input-group">
                                            <input type="file" id="csv-file-input" class="form-control" accept=".csv">
                                            <button id="analyze-csv-btn" class="btn btn-info">Analyze</button>
                                        </div>
                                        <div id="csv-analysis-results" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <footer class="text-center text-muted py-3 border-top">
            <small><a href="#" data-bs-toggle="modal" data-bs-target="#disclaimerModal">Disclaimer / 免責事項</a></small>
        </footer>
    </div>

    <!-- Disclaimer Modal -->
    <div class="modal fade" id="disclaimerModal" tabindex="-1" aria-labelledby="disclaimerModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="disclaimerModalLabel">⚠️ Disclaimer / 免責事項</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <h6>English</h6>
            <p><strong>IMPORTANT: This application is provided for educational and informational purposes only.</strong></p>
            <ul>
              <li><strong>Not Financial Advice</strong>: The information, analysis, and tools provided by this application do NOT constitute financial, investment, trading, or any other type of professional advice.</li>
              <li><strong>No Investment Recommendations</strong>: This application does not provide personalized investment recommendations. Any portfolio suggestions or optimizations are based solely on historical data and mathematical models.</li>
              <li><strong>Past Performance</strong>: Historical performance data and simulations do not guarantee future results. Investment returns can be volatile and unpredictable.</li>
              <li><strong>Use at Your Own Risk</strong>: You acknowledge that any investment decisions made based on information from this application are made at your sole discretion and risk.</li>
              <li><strong>No Liability</strong>: The developers, contributors, and operators of this application shall not be liable for any direct, indirect, incidental, special, consequential, or exemplary damages, including but not limited to:
                <ul>
                  <li>Loss of profits</li>
                  <li>Loss of capital</li>
                  <li>Trading losses</li>
                  <li>Opportunity costs</li>
                  <li>Data inaccuracies</li>
                  <li>System errors or downtime</li>
                </ul>
              </li>
              <li><strong>Data Accuracy</strong>: While we strive to provide accurate data through Yahoo Finance integration, we cannot guarantee the accuracy, completeness, or timeliness of any information.</li>
              <li><strong>Consult Professionals</strong>: Before making any investment decisions, you should consult with qualified financial advisors, tax professionals, and legal counsel.</li>
              <li><strong>Regulatory Compliance</strong>: Users are responsible for ensuring their use of this application complies with all applicable laws and regulations in their jurisdiction.</li>
            </ul>
            <p><strong>BY USING THIS APPLICATION, YOU ACKNOWLEDGE THAT YOU HAVE READ, UNDERSTOOD, AND AGREE TO THIS DISCLAIMER.</strong></p>
            <hr>
            <h6>日本語</h6>
            <p><strong>重要: このアプリケーションは教育および情報提供のみを目的として提供されています。</strong></p>
            <ul>
              <li><strong>金融アドバイスではありません</strong>: 本アプリケーションが提供する情報、分析、ツールは、金融、投資、取引、その他いかなる種類の専門的アドバイスも構成するものではありません。</li>
              <li><strong>投資推奨ではありません</strong>: 本アプリケーションは個別の投資推奨を提供するものではありません。ポートフォリオの提案や最適化は、過去のデータと数学的モデルのみに基づいています。</li>
              <li><strong>過去の実績</strong>: 過去のパフォーマンスデータやシミュレーションは、将来の結果を保証するものではありません。投資リターンは変動性が高く、予測不可能です。</li>
              <li><strong>自己責任での使用</strong>: 本アプリケーションからの情報に基づいて行われる投資判断は、すべてあなた自身の裁量とリスクで行われることを承認します。</li>
              <li><strong>免責事項</strong>: 本アプリケーションの開発者、貢献者、運営者は、以下を含むがこれに限定されない、直接的、間接的、偶発的、特別、結果的、または懲罰的損害について一切の責任を負いません:
                <ul>
                  <li>利益の損失</li>
                  <li>資本の損失</li>
                  <li>取引損失</li>
                  <li>機会損失</li>
                  <li>データの不正確性</li>
                  <li>システムエラーまたはダウンタイム</li>
                </ul>
              </li>
              <li><strong>データの正確性</strong>: Yahoo Financeとの連携により正確なデータを提供するよう努めていますが、情報の正確性、完全性、適時性を保証することはできません。</li>
              <li><strong>専門家への相談</strong>: 投資判断を行う前に、資格を持つファイナンシャルアドバイザー、税理士、法律顧問に相談してください。</li>
              <li><strong>規制遵守</strong>: ユーザーは、本アプリケーションの使用が自身の管轄区域におけるすべての適用法令に準拠していることを確認する責任を負います。</li>
            </ul>
            <p><strong>本アプリケーションを使用することにより、あなたはこの免責事項を読み、理解し、同意したことを認めます。</strong></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script type="module" src="/static/theme.js"></script>
    <script type="module" src="/static/main.js"></script>
</body>
</html>
